# PR604

## Vista de tipo lista

### Creación del módulo de trabajo

En esta práctica se pide crear un módulo en Odoo para la gestión de suscripciones de clientes.  
El módulo permitirá visualizar la información de las suscripciones mediante distintas vistas, aplicar decoraciones, usar widgets y añadir una acción personalizada mediante un botón.

Para comenzar con esta tarea, crearemos un módulo, pero no de manera manual, ya que Odoo proporciona una herramienta para ello. Para crearlo deberemos acceder mediante la línea de comandos al contenedor Odoo. Utilizaremos el comando `docker exec -t -i id_contenedor bash`. Dentro del contenedor podremos crear la estructura del módulo con odoo scaffold. 

```
odoo scaffold nombre_modulo /mnt/extra-addons/
```

Es importante que creemos los módulos en *extra-addons*. Una vez ejecutado, se habrán creado las carpetas con las que trabajaremos.

### Configuración del modelo

Para poder gestionar las suscripciones, es necesario definir un modelo con los campos indicados en el enunciado.  
En mi caso, he creado el archivo `models/suscription.py` (tiene una errata en el nombre, pero avancé con dicha errata), que contiene el siguiente código:

```python
# -*- coding: utf-8 -*-

from odoo import models, fields, api
from dateutil.relativedelta import relativedelta


class suscription(models.Model):
    _name = 'suscription.management'
    _description = 'suscription.suscription'

    name = fields.Char(
        string="Nombre",
        required=True
    )

    customer_id = fields.Many2one(
        comodel_name='res.partner',
        string="Cliente",
        required=True
    )

    subscription_code = fields.Char(
        string="Código de suscripción",
        required=True
    )

    start_date = fields.Date(
        string="Fecha de inicio",
        required=True
    )

    end_date = fields.Date(
        string="Fecha final"
    )

    duration_months = fields.Integer(
        string="Duración de la suscripción",
        compute="_compute_duration_months",
        store=True
    )

    renewal_date = fields.Date(
        string="Fecha de renovación"
    )

    status = fields.Selection(
        selection=[
            ('active', 'Active'),
            ('expired', 'Expired'),
            ('pending', 'Pending'),
            ('cancelled', 'Cancelled')
        ],
        string="Estado"
    )

    is_renewable = fields.Boolean(
        string="Puede renovarse"
    )

    auto_renewal = fields.Boolean(
        string="Renovación automática"
    )

    price = fields.Float(
        string="Precio"
    )

    usage_limit = fields.Integer(
        string="Límite de usos"
    )

    current_usage = fields.Integer(
        string="Servicios utilizados"
    )

    use_percent = fields.Float(
        string="Porcentaje utilizado",
        compute="_compute_use_percent",
        store=True
    )

    @api.depends('start_date', 'end_date')
    def _compute_duration_months(self):
        for record in self:
            if not record.start_date or not record.end_date:
                record.duration_months = 0
                continue

            delta = relativedelta(record.end_date, record.start_date)
            record.duration_months = delta.years * 12 + delta.months

    @api.depends('usage_limit', 'current_usage')
    def _compute_use_percent(self):
        for record in self:
            if not record.usage_limit:
                record.use_percent = 0
            else:
                record.use_percent = (record.current_usage / record.usage_limit) * 100

    def extension_days(self):
        for record in self:
            if record.end_date:
                record.end_date = record.end_date + relativedelta(days=15)
```

Este modelo define todos los campos requeridos por la práctica, incluyendo campos calculados para la duración de la suscripción y el porcentaje de uso.
Además, se incluye un método que será utilizado por un botón para ampliar la suscripción en 15 días.

### Creación de las vistas

Para cumplir con el enunciado, se crean dos vistas de tipo árbol sobre el mismo modelo: Una vista para mostrar los datos básicos de la suscripción y otra vista para mostrar los datos de uso

Las vistas se definen en el archivo `views/subscription_views.xml`. En mi caso, el archivo quedó así:

```xml
<odoo>
  <data>
    <!-- 1. Vista árbol básica
      - name: Nombre de la vista
      - model: Modelo al que pertenece la vista
      - arch: Arquitectura de la vista en XML
      - tree: Elemento que define la vista de lista
        - [...]: Campos para cada elemento
    -->
    <record id="view_subscription_tree_basic" model="ir.ui.view">
      <field name="name">suscription list</field>
      <field name="model">suscription.management</field>
      <field name="arch" type="xml">
        <tree decoration-danger="status=='expired'" decoration-warning="status=='cancelled'" limit="15">
          <field name="name" string="Nombre"/>
          <field name="customer_id" string ="ID del Cliente"/>
          <field name="subscription_code" string ="Código de suscripción"/>
          <field name="start_date" string ="Fecha de inicio"/>
          <field name="end_date" string ="Fecha de fin" widget="remaining_days"/>
          <field name="duration_months" string ="Duración de la suscripción"/>
          <button name= "extension_days" type="object" string="Ampliación de 15 días" class="btn-primary" icon="fa-plus"/>
          <field name="renewal_date" string ="Fecha de renovación"/>
          <field name="status" string ="Estado" widget="radio"/>
          <field name="is_renewable" string ="Puede ser renovado"/>
          <field name="auto_renewal" string ="Renovación automática"/>
          <field name="price" string ="Precio" attrs="{'invisible': [('status', '=', 'cancelled')]}"/>
        </tree>
      </field>
    </record>

    <!-- 2. Acción para la vista básica
      - name: Nombre de la acción
      - res_model: Modelo de recurso
      - view_mode: Modos de vista disponibles
      - view_id: ID de la vista por defecto. Usa el ref para referenciar la vista creada antes
    -->

    <record id="action_subscription_basic" model="ir.actions.act_window">
      <field name="name">Suscripciones (Básico)</field>
        <field name="res_model">suscription.management</field>
        <field name="view_mode">tree,form</field>
        <!-- Dice que vista usar primero -->
        <field name="view_id" ref="view_subscription_tree_basic"/>
    </record>
    


    <!-- 3. Vista árbol de uso
      - name: Nombre de la vista
      - model: Modelo al que pertenece la vista
      - arch: Arquitectura de la vista en XML
      - tree: Elemento que define la vista de lista
    -->

    <record id="view_subscription_tree_usage" model="ir.ui.view">
      <field name="name">suscription list</field>
      <field name="model">suscription.management</field>
      <field name="arch" type="xml">
      <tree>
          <field name="name" string="Nombre"/>
          <field name="usage_limit" string="Limite de uso" widget="progressbar"/>
          <field name="current_usage" string ="Servicios usados actualmente"/>
          <field name="use_percent" string ="Servicios utilizados" decoration-danger="use_percent >= 80" avg="1"/>
      </tree>
      </field>
    </record>


    <!-- 4. Acción para la vista de uso
      - name: Nombre de la acción
      - res_model: Modelo de recurso
      - view_mode: Modos de vista disponibles
      - view_id: ID de la vista por defecto
    -->
    <record id="action_subscription_usage" model="ir.actions.act_window">
        <field name="name">Suscripciones (Uso)</field>
        <field name="res_model">suscription.management</field>
        <field name="view_mode">tree,form</field>
        <field name="view_id" ref="view_subscription_tree_usage"/>
    </record>

    <!-- 5. Menú raíz
      - name: Nombre del menú
      - id: Identificador único del menú
    -->
    <menuitem name="suscription" id="suscription.menu_root"/>

    <!-- 6. Menú para la vista básica
      - name: Nombre del menú
      - id: Identificador único del menú
      - parent: Menú padre
      - action: Acción asociada
    -->
    <menuitem name="Suscripciones (Básico)" id="suscription.menu_1" parent="suscription.menu_root" action="action_subscription_basic"/>

    <!-- 7. Menú para la vista de uso
      - name: Nombre del menú
      - id: Identificador único del menú
      - parent: Menú padre
      - action: Acción asociada
    -->
    <menuitem name="Suscripciones (Uso)" id="suscription.menu_2" parent="suscription.menu_root" action="action_subscription_usage"/>
  </data>
</odoo>
```

### Configuración del manifiesto

Por último, se añade el archivo de vistas al manifiesto del módulo `__manifest__.py` para que Odoo lo cargue correctamente.

```python
'data': [
    'security/ir.model.access.csv',
    'views/subscription_views.xml',
],
```


Una vez instalado el módulo, se puede gestionar la información de las suscripciones desde el menú principal, accediendo a vistas diferenciadas para los datos básicos y los datos de uso, con decoraciones visuales, cálculos automáticos y una acción personalizada para ampliar la duración de la suscripción.