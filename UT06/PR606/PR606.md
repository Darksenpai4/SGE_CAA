# PR502

## Desarrollo de un módulo para la gestión de un taller mecánico

### Creación del módulo de trabajo

En esta práctica se solicita el desarrollo de un módulo personalizado de Odoo para la gestión interna de un pequeño taller mecánico. El módulo permitirá gestionar clientes, vehículos, reparaciones, piezas y técnicos.

Para comenzar, accedemos al contenedor de Odoo mediante la línea de comandos utilizando el siguiente comando:

`docker exec -t -i id_contenedor bash`

Una vez dentro del contenedor, creamos la estructura básica del módulo utilizando la herramienta `odoo scaffold`, que nos genera automáticamente todos los directorios necesarios.

`odoo scaffold taller_mecanico /mnt/extra-addons/`


Es importante crear el módulo dentro de la carpeta *extra-addons*, ya que es donde Odoo busca los módulos personalizados. Tras ejecutar el comando, se genera la estructura básica del módulo.

Dentro del directorio del módulo podemos encontrar las carpetas principales como `models`, `views`, `security` y el archivo `__manifest__.py`.

---

## Definición de los modelos

Para cumplir con los requisitos de la práctica, se han definido cuatro modelos principales:

- Cliente
- Vehículo
- Reparación
- Pieza

Todos los modelos se han implementado dentro de la carpeta `models`.

---

### Modelo cliente

Dentro de la carpeta `models` se ha creado el archivo `cliente.py` con el siguiente contenido:

```python
# -*- coding: utf-8 -*-

from odoo import models, fields

class TallerCliente(models.Model):
    _name = 'taller.cliente'
    _description = 'Cliente del taller'

    name = fields.Char(string='Nombre', required=True)
    telefono = fields.Char(string='Teléfono')
    email = fields.Char(string='Email')
    direccion = fields.Text(string='Dirección')

    vehiculo_ids = fields.One2many(
        'taller.vehiculo',
        'cliente_id',
        string='Vehículos'
    )
```
Este modelo representa a los clientes del taller y permite relacionar cada cliente con uno o varios vehículos mediante una relación One2many.

### Modelo vehículo

Para los vehículos se ha creado el archivo vehiculo.py:

```python
# -*- coding: utf-8 -*-

from odoo import models, fields

class TallerVehiculo(models.Model):
    _name = 'taller.vehiculo'
    _description = 'Vehículo del cliente'

    matricula = fields.Char(string='Matrícula', required=True)
    marca = fields.Char(string='Marca')
    modelo = fields.Char(string='Modelo')
    anio = fields.Integer(string='Año')

    cliente_id = fields.Many2one(
        'taller.cliente',
        string='Cliente',
        required=True
    )

    reparacion_ids = fields.One2many(
        'taller.reparacion',
        'vehiculo_id',
        string='Reparaciones'
    )
```

Este modelo permite registrar los vehículos de cada cliente y relacionarlos con las reparaciones realizadas.

### Modelo pieza

El modelo de piezas se ha definido en el archivo pieza.py:

```python
# -*- coding: utf-8 -*-

from odoo import models, fields, api
from odoo.exceptions import ValidationError

class TallerPieza(models.Model):
    _name = 'taller.pieza'
    _description = 'Pieza del taller'

    nombre = fields.Char(string='Nombre', required=True)
    codigo = fields.Char(string='Código')
    precio_unitario = fields.Float(string='Precio unitario')

    reparacion_ids = fields.Many2many(
        'taller.reparacion',
        string='Reparaciones'
    )

    @api.constrains('precio_unitario')
    def _check_precio(self):
        for record in self:
            if record.precio_unitario <= 0:
                raise ValidationError('El precio debe ser superior a 0')
```

En este modelo se ha añadido una validación para asegurar que el precio unitario sea superior a 0, tal y como se solicita en la práctica.

Modelo reparación

El archivo reparacion.py contiene el modelo más completo del módulo:

```python
# -*- coding: utf-8 -*-

from odoo import models, fields, api

class TallerReparacion(models.Model):
    _name = 'taller.reparacion'
    _description = 'Reparación'

    fecha_inicio = fields.Date(string='Fecha inicio')
    fecha_fin = fields.Date(string='Fecha fin')
    descripcion = fields.Text(string='Descripción')

    estado = fields.Selection([
        ('borrador', 'Borrador'),
        ('en_curso', 'En curso'),
        ('finalizada', 'Finalizada')
    ], default='borrador')

    vehiculo_id = fields.Many2one(
        'taller.vehiculo',
        string='Vehículo',
        required=True
    )

    tecnico_id = fields.Many2one(
        'res.users',
        string='Técnico'
    )

    pieza_ids = fields.Many2many(
        'taller.pieza',
        string='Piezas'
    )

    coste_total = fields.Float(
        string='Coste total',
        compute='_compute_coste_total',
        store=True
    )

    @api.depends('pieza_ids.precio_unitario')
    def _compute_coste_total(self):
        for record in self:
            record.coste_total = sum(
                record.pieza_ids.mapped('precio_unitario')
            )

    def action_abrir(self):
        self.estado = 'en_curso'

    def action_cerrar(self):
        self.estado = 'finalizada'

    def action_reabrir(self):
        self.estado = 'borrador'
```

El campo coste_total se calcula automáticamente a partir del precio de las piezas asociadas a la reparación.


---

## Vistas e interfaz de usuario

Todas las vistas del módulo se han definido dentro de la carpeta views. Cada modelo cuenta con una vista en formato lista y formulario.

### Vista de piezas

En el modelo pieza se ha aplicado formato condicional en la vista tipo árbol para colorear los registros según el precio:

- Precio menor de 10 € → verde
- Precio mayor de 100 € → rojo
- Precio intermedio → sin color

```xml
<odoo>
    <data>

        <!-- Vista lista de piezas -->
        <record id="view_taller_pieza_tree" model="ir.ui.view">
            <field name="name">taller.pieza.tree</field>
            <field name="model">taller.pieza</field>
            <field name="arch" type="xml">
                <tree decoration-success="precio_unitario &lt; 10"
                      decoration-danger="precio_unitario &gt; 100">
                    <field name="nombre"/>
                    <field name="codigo"/>
                    <field name="precio_unitario"/>
                </tree>
            </field>
        </record>

        <!-- Vista formulario de piezas -->
        <record id="view_taller_pieza_form" model="ir.ui.view">
            <field name="name">taller.pieza.form</field>
            <field name="model">taller.pieza</field>
            <field name="arch" type="xml">
                <form>
                    <sheet>
                        <group>
                            <field name="nombre"/>
                            <field name="codigo"/>
                            <field name="precio_unitario"/>
                            <field name="reparacion_ids" widget="many2many_tags"/>
                        </group>
                    </sheet>
                </form>
            </field>
        </record>

        <!-- Acción -->
        <record id="action_taller_pieza" model="ir.actions.act_window">
            <field name="name">Piezas</field>
            <field name="res_model">taller.pieza</field>
            <field name="view_mode">tree,form</field>
        </record>

    </data>
</odoo>
```

### Vista de reparaciones

En el modelo reparación se han aplicado los siguientes requisitos visuales y funcionales:

- Coloreado del estado en la vista lista:
    - Borrador → gris
    - En curso → azul
    - Finalizada → verde

- Botones para cambiar el estado:
    - Abrir reparación
    - Cerrar reparación
    - Reabrir

- El campo coste_total se colorea según su valor:
    - Mayor de 500 € → rojo
    - Entre 100 y 500 € → naranja
    - Menor de 100 € → verde

- Cuando el estado es finalizada, todos los campos quedan en solo lectura, excepto el botón de reabrir.

El archivo views/reparacion_views.xml contiene el siguiente código:

```xml
<odoo>
    <data>

        <!-- Vista lista de reparaciones -->
        <record id="view_taller_reparacion_tree" model="ir.ui.view">
            <field name="name">taller.reparacion.tree</field>
            <field name="model">taller.reparacion</field>
            <field name="arch" type="xml">
                <tree decoration-muted="estado == 'borrador'"
                      decoration-info="estado == 'en_curso'"
                      decoration-success="estado == 'finalizada'">
                    <field name="vehiculo_id"/>
                    <field name="fecha_inicio"/>
                    <field name="fecha_fin"/>
                    <field name="estado"/>
                    <field name="coste_total"
                           decoration-danger="coste_total &gt; 500"
                           decoration-warning="coste_total &gt;= 100 and coste_total &lt;= 500"
                           decoration-success="coste_total &lt; 100"/>
                </tree>
            </field>
        </record>

        <!-- Vista formulario de reparaciones -->
        <record id="view_taller_reparacion_form" model="ir.ui.view">
            <field name="name">taller.reparacion.form</field>
            <field name="model">taller.reparacion</field>
            <field name="arch" type="xml">
                <form>
                    <header>
                        <button name="action_abrir"
                                string="Abrir reparación"
                                type="object"
                                states="borrador"/>

                        <button name="action_cerrar"
                                string="Cerrar reparación"
                                type="object"
                                states="en_curso"/>

                        <button name="action_reabrir"
                                string="Reabrir"
                                type="object"
                                states="finalizada"/>

                        <field name="estado" widget="statusbar"/>
                    </header>

                    <sheet>
                        <group attrs="{'readonly': [('estado', '=', 'finalizada')]}">
                            <field name="vehiculo_id"/>
                            <field name="tecnico_id"/>
                            <field name="fecha_inicio"/>
                            <field name="fecha_fin"/>
                            <field name="descripcion"/>
                            <field name="pieza_ids" widget="many2many_tags"/>
                            <field name="coste_total" readonly="1"/>
                        </group>
                    </sheet>
                </form>
            </field>
        </record>

        <!-- Acción -->
        <record id="action_taller_reparacion" model="ir.actions.act_window">
            <field name="name">Reparaciones</field>
            <field name="res_model">taller.reparacion</field>
            <field name="view_mode">tree,form</field>
        </record>

    </data>
</odoo>
```

--- 

## Configuración del módulo

Para que el módulo cargue correctamente todos los archivos creados, se ha modificado el archivo `__manifest__.py`:

```python
# -*- coding: utf-8 -*-
{
    'name': 'Taller Mecánico',
    'summary': 'Gestión interna de un taller mecánico',
    'version': '1.0',
    'category': 'Services',
    'author': 'Autor',
    'depends': ['base'],
    'data': [
        'security/ir.model.access.csv',
        'views/cliente_views.xml',
        'views/vehiculo_views.xml',
        'views/pieza_views.xml',
        'views/reparacion_views.xml',
        'views/menu.xml'
    ],
    'installable': True,
}
```

Una vez instalado el módulo desde el panel de aplicaciones de Odoo, se puede comprobar que se pueden crear clientes y asignarles vehículos. Cada vehículo puede tener varias reparaciones. Las reparaciones permiten asignar piezas y técnicos. El coste total se calcula automáticamente y los colores y validaciones funcionan según lo solicitado.