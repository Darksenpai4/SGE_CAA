# PR702

## API REST

### Endpoint 1: GET /api/suscription

El primer endpoint devolverá una relación de todas las suscripciones almacenadas en la base de datos. Además, podrá recibir una query string llamada `status` para filtrar por estado.  

Si el valor recibido en `status` no es uno de los permitidos, deberá devolver un **400 Bad Request** con un mensaje de error.

Todo esto se implementará en el archivo: `controllers/controllers.py`.

Primero, importaremos `request` y `json`, ya que vamos a construir respuestas HTTP personalizadas en formato JSON.

```python
# -*- coding: utf-8 -*-
from odoo import http
from odoo.http import request
import json


class Suscription(http.Controller):

    @http.route('/api/suscription', type='http', auth='public', methods=['GET'], csrf=False)
    def get_suscriptions(self, **kw):

        status = kw.get('status')
        domain = []

        allowed_status = ['draft', 'active', 'cancelled']

        if status:
            if status not in allowed_status:
                return request.make_response(
                    json.dumps({'error': 'Invalid status value'}),
                    headers=[('Content-Type', 'application/json')],
                    status=400
                )
            domain.append(('status', '=', status))

        suscriptions = request.env['suscription.suscription'].search(domain)

        result = []
        for s in suscriptions:
            result.append({
                'name': s.name,
                'status': s.status,
                'price': s.price,
            })

        return request.make_response(
            json.dumps(result),
            headers=[('Content-Type', 'application/json')]
        )
```

Donde `type='http'` permite construir una respuesta HTTP manual; `kw.get('status')` obtiene la query string;  `allowed_status` define los valores válidos y si el estado no es válido, se devuelve un `status=400`; `search(domain)` filtra si se ha indicado estado y se construye manualmente la respuesta en formato JSON y por último, `csrf=False` es necesario para permitir llamadas externas tipo API.

---

### Endpoint 2: GET /api/suscription/:name

El segundo endpoint devolverá toda la información de una suscripción concreta cuyo nombre se pase como parámetro en la URL.

Se añade debajo del método anterior en el mismo archivo `controllers/controllers.py`.

```python
    @http.route('/api/suscription/<string:name>', type='http', auth='public', methods=['GET'], csrf=False)
    def get_suscription_by_name(self, name):

        suscription = request.env['suscription.suscription'].search([
            ('name', '=', name)
        ], limit=1)

        if not suscription:
            return request.make_response(
                json.dumps({'error': 'Suscription not found'}),
                headers=[('Content-Type', 'application/json')],
                status=404
            )

        result = {
            'name': suscription.name,
            'status': suscription.status,
            'price': suscription.price,
            'start_date': str(suscription.start_date),
            'end_date': str(suscription.end_date),
        }

        return request.make_response(
            json.dumps(result),
            headers=[('Content-Type', 'application/json')]
        )
```

En este segundo método `<string:name>` captura el parámetro de la URL y se busca la suscripción por nombre con `limit=1`. Se devuelve la respuesta en formato JSON.
- Si no existe, se devuelve un `404 Not Found`.
- Si existe, se construye un diccionario con todos los datos.

Con esto quedaría implementada correctamente la API REST del ejercicio.